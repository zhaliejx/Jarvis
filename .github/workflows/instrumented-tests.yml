name: Instrumented Tests

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0' # Weekly Sunday run

jobs:
  test:
    runs-on: macos-latest # Using macOS for faster emulator startup

    strategy:
      matrix:
        api-level: [24, 28, 30, 34]

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ matrix.api-level }}
        build-tools-version: 34.0.0
        ndk-version: '25.1.8937393'
        cmake-version: '3.22.1'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest

    - name: Start Emulator
      run: |
        echo no | avdmanager create avd -n test -k "system-images;android-${{ matrix.api-level }};google_apis;arm64-v8a"
        emulator -avd test -no-snapshot -no-window -gpu swiftshader_indirect -skin 768x1280 -partition-size 4096 -wipe-data &

    - name: Wait for Emulator
      run: |
        adb wait-for-device
        adb shell settings put global window_animation_scale 0 &
        adb shell settings put global transition_animation_scale 0 &
        adb shell settings put global animator_duration_scale 0 &

    - name: Run Instrumented Tests
      run: ./gradlew connectedDebugAndroidTest --stacktrace

    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.api-level }}
        path: app/build/outputs/reports/androidTests/connected/